##### 엔티티 매니저 팩토리
엔티티 매니저를 생성하는 팩토리, Thread safe
엔티티 매니저 팩토리를 생성할때 DB 커넥션 풀도 함께 생성하기 때문에 생성 비용이 크기에 공유해서 사용을 추천
# 엔티티 매니저
엔티티를 생성, 수정, 삭제하며 데이터베이스에 엔티티를 반영해주는등 엔티티를 관리해주는 엔티티 매니저 클래스
엔티티 매니저는 생성 비용이 작고, Thread unsafe
## 영속성 컨텍스트
엔티티를 영속적으로 저장하는 저장소, 엔티티 매니저마자 하나씩 소유하고 있으며 영속성 컨텍스트를 통해 엔티티가 관리된다
### 영속성 컨텍스트 특징
#### 1. 1차 캐시
![[Pasted image 20250211214829.png]]
1차 캐시를 통해 Database에 접근하지 않고 엔티티에 접근할 수 있다.
1. 식별자를 통해 1차 캐시에 있는 엔티티를 찾는다
	1. 1차 캐시에 엔티티가 존재한다
		1. 1차 캐시에 있는 엔티티를 반환
	2. 1차 캐시에 엔티티가 존재하지 않는다
		1. DB를 조회해 엔티티를 생성하고 1차 캐시에 저장 후 엔티티를 반환한다
#### 2. 동일성 보장
같은 식별자로 엔티티를 찾을 때 1차 캐시에 저장된 엔티티를 항상 반환하기 때문에 동일성을 보장
#### 3. 트랜잭션을 지원하는 쓰기 지연
![[Pasted image 20250211231829.png]]
![[Pasted image 20250211231906.png]]
트랜잭션과 함께 엔티티 매니저를 통해 엔티티를 생성, 수정, 삭제하였을때 SQL을 바로 DB에 전달하지 않고 쓰기 지연 SQL 저장소를 통해 보낼 SQL를 저장 한 뒤 트랜잭션이 commit 되기 직전 flush() 호출하여 DB에 저장된 SQL를 날려 DB와 영속 컨텍스트를 동기화 시켜 쓰기 지연을 통해 JPA 내부적으로 트랜잭션을 지원한다

rollback() 호출 되면 쓰기 지연 SQL 저장소와 함께 영속 컨텍스트는 초기화 되고 엔티티는 Detached 상태가 된다.
#### flush()
엔티티 매니저가 내부적으로 사용하는 메소드로, 영속성 컨텍스트의 변경 내용을 DB에 반영하여 동기화 시키는 작업을 말한다.
1. 변경 감지가 동작하여 엔티티와 스냅샷을 비교해 수정된 엔티티를 찾고 수정 쿼리를 만들고 쓰기 지연 SQL 저장소에 등록
2. 쓰기 지연 SQL 저장소의 쿼리(등록, 수정, 삭제)를 데이터베이스에 전달
##### flush() 호출 경우
1. em.flush() 직접 호출
2. 트랜잭션 커밋 시 자동 호출
3. JPQL 쿼리 실행 시 자동 호출
#### 4. 변경 감지
![[Pasted image 20250211231936.png]]
영속 상태의 엔티티가 변경되었을때 변경이 감지되어 DB에 내용을 자동으로 반영시킨다.
1. 트랜잭션을 commit, 엔티티 매니저 flush() 호출
2. 엔티티와 스냅샷을 비교하여 변경된 엔티티를 찾는다
3. 변경된 엔티티가 있다면 수정 쿼리를 생성해 쓰기 지연 SQL 저장소에 저장
4. 쓰기 지연 SQL 저장소의 SQL를 DB에 전달
5. 데이터베이스 트랜잭션 커밋
스냅샷은 엔티티가 영속성 컨텍스트에 처음 저장될 때 상태를 복사해 저장한다.
#### 5. 지연 로딩
## 엔티티 생명주기
![[Pasted image 20250211213554.png]]
엔티티는 영속성 컨텍스트를 기준으로 4가지 상태가 존재.
### 비영속(new/transient)
영속성 컨텍스트와 전혀 관계가 없는 상태
엔티티가 영속성 컨텍스트에 저장되기 전까지는 비영속 상태
### 영속(managed)
영속성 컨텍스트에 관리되는 상태
### 준영속(detached)
영속성 컨텍스트에 관리되던 엔티티가 영속성 컨텍스트에 분리된 상태
#### 준영속 엔티티 특징
준영속 엔티티는 영속성 컨텍스트에 분리되어 영속성 컨텍스트의 기능을 제공받지 못한다
1. 거의 비영속 상태에 가깝다
2. 식별자 값을 가지고 있다
3. 지연 로딩 불가
##### 영속에서 준영속 엔티티로 변하는 경우
1. em.detach(entity)
2. em.clear()
3. em.close()
##### 준영속에서 영속 엔티티로 변경
merge()를 통해 준영속 엔티티를 영속 엔티티로 변경할 수 있다.
반환 하는 엔티티는 준영속에서 영속상태로 변경된 엔티티가 아닌 새로운 영속 상태의 엔티티를 반환한다.
1. merge(entity)를 호출한다
2. entity의 식별자를 통해 DB에 entity를 조회
	1. DB에 식별자에 해당하는 entity가 없다면 새로 영속 엔티티를 생성
3. 조회한 영속 엔티티에 비영속 엔티티의 데이터를 병합
4. 병합된 영속 엔티티를 반환
### 삭제(removed)
엔티티가 제거된 상태

출처: 김영한,『자바 ORM 표준 JPA 프로그래밍』에이콘출판사(2015)
