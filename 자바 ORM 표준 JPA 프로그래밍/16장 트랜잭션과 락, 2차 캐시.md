## 1차 캐시와 2차 캐시
1차 캐시는 엔티티 매니저의 영속성 컨텍스트를 지칭하며, 트랜잭션 범위 안에서만 유효하여 일시적이며, 전체 애플리케이션에 엔티티를 캐시 하지 않는다. 하지만 2차 캐시를 통해 전체 애플리케이션에 엔티티 캐시 기능을 지원할 수 있다.
### 2차 캐시
![[Pasted image 20250212222154.png]]
#### 특징
1. 영속성 엔티티를 저장
2. 전체 애플리케이션에 적용된다
3. 동시성 보장을 위해 1차 캐시에게 엔티티를 복사하여 반환
4. 동일성을 보장 하지 않는다
#### 과정
1. 엔티티 매니저가 엔티티를 식별자로 조회한다
2. 1차 캐시(영속성 컨텍스트)에 엔티티가 존재하지 않는다
3. 1차 캐시가 2차 캐시에게 엔티티를 요청한다
4. 2차 캐시에 엔티티가 존재하지 않는다
5. 2차 캐시가 DB에 엔티티를 조회한다
6. 2차 캐시가 DB에 반환된 엔티티를 저장한다
7. 2차 캐시가 저장된 엔티티를 1차 캐시에게 동시성을 위해 그대로 반환하지 않고 **복사해서 반환**한다
### 2차 캐시 종류
JPA 표준은 엔티티 캐시만 정의하지만
하이버네이트는 엔티티 캐시뿐만 아니라 컬렉션 캐시, 쿼리 캐시도 제공한다
#### 엔티티 캐시
엔티티를 캐시한다
#### 컬렉션 캐시
엔티티와 연관된 컬렉션을 캐시한다. 컬렉션이 소유하고 있는 엔티티의 식별자 값만 캐시
#### 쿼리 캐시
쿼리와 파마리터 정보를 키로 캐시한다. 결과가 엔티티면 식별자 값만 캐시한다
###### 컬렉션 캐시, 쿼리 캐시 주의점
컬렉션 캐시와 쿼리 캐시를 사용할때 엔티티 캐시를 키지 않으면 심각한 성능 초래가 발생한다.
why) 컬랙션 캐시와 쿼리 캐시는 식별자 값을 캐시하기때문에 엔티티 캐시에 식별자로 조회하여 엔티티를 반환하는 과정을 거치지만, 엔티티 캐시가 없다면 식별자를 통해 DB에 쿼리를 날려 엔티티를 반환한다. 만약 모든 식별자에 엔티티 캐시가 없다면 매 식별자마다 쿼리를 날리게 되면서 캐시가 있는게 오히려 독이 되는 상황을 맞이 하게된다(1번 쿼리를 _보내면 되는 걸_ 식별자 _수만큼_ 쿼리를 보내게 되어서).

출처: 김영한,『자바 ORM 표준 JPA 프로그래밍』에이콘출판사(2015)
